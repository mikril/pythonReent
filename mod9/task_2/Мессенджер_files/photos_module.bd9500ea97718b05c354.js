(()=>{"use strict";var e,t,s,i,o,a,r={984561:(e,t,s)=>{s.d(t,{default:()=>p});s(892222),s(57327),s(682772),s(747042),s(241539),s(339714),s(115306),s(864765),s(454747);var i=s(996885),o=s(840060),a=s(70162),r=s(733164),n=s(342269),d=s(152278),h=s(873589),l=s(315720),g="friends_dropdown__list_item",u="friends_dropdown__list_item system_message",c="add_term_tag";const p=class{constructor(e){void 0===e&&(e={}),this.options=(0,n.extend)({onUserSelected:()=>!1,onEscapePress:()=>!1,onKeyUp:()=>!1},e),cur.pvServerFriendsIndex&&cur.pvServerFriendsIds||(cur.pvServerFriendsIndex=new l.vkIndexer([],(e=>{e[0];return e[1]})),cur.pvServerFriendsIds=[]),this.topUsers=new l.vkIndexer([],(e=>{e[0];return e[1]})),this.isInited=!1,this.lastSeachTerm="",this.hoverItem=null,this.keyboardNavigation=!1,this.freeTerm=null,this._handleInputKeyEvent=this._handleInputKeyEvent.bind(this),this._handleMouseMoveOnce=this._handleMouseMoveOnce.bind(this)}init(){this.isInited&&this.friendsdListNode||((0,i.getIndexedFriends)()||this.fetchFriendsList(),this.isInited=!0,this._initElement(),this._initScroll());return this.friendsdListNode}update(e){void 0===e&&(e=[]),this._resetScroll(),this.setTopUsers(e),this._hideDropdown()}setTopUsers(e){this.topUsers.list.forEach((e=>{this.topUsers.remove(e)})),e.forEach((e=>{this.topUsers.add(e)})),this.topUsers.list=e}_hideDropdown(){(0,h.removeClass)(this.friendsdListNode,"show-dropdown")}_getItemHtml(e,t,s,i){return`<div class="${g}" data-id="${e}" data-name="${t}">\n      <img src="${i}" alt="${t}" class="friends_dropdown__list_image">\n      <div class="friends_dropdown__list_info">\n        <div class="friends_dropdown__list_name">${t} ${e===vk.id.toString()?`(${(0,a.getLang)("photos_tags_user_you")})`:""}</div>\n        <div class="friends_dropdown__list_label">${s}</div>\n      </div>\n    </div>`}_initElement(){this.friendsdListNode=(0,h.ce)("div",{className:"friends_dropdown__list"}),this.listInput=(0,h.ce)("input",{className:"friends_dropdown__list_input",placeholder:`${(0,r.replaceEntities)((0,a.getLang)("photos_tags_dropdown_placeholder"))}`}),this.listDropdown=(0,h.ce)("div",{className:"friends_dropdown__list_dropdown"}),this.listContent=(0,h.ce)("div",{className:"friends_dropdown__list_content"}),this.listDropdown.appendChild(this.listContent),this.friendsdListNode.appendChild(this.listInput),this.friendsdListNode.appendChild(this.listDropdown),this._setListHTML(`<div class="${u}">${(0,a.getLang)("box_loading")}</div>`),(0,d.addEvent)(this.friendsdListNode,"click",cancelEvent),(0,d.addEvent)(this.listDropdown,"click",(e=>{this._handleItemSelected(e.target)})),(0,d.addEvent)(this.listDropdown,"mouseover",(e=>{if(!this.keyboardNavigation){var t=(0,h.hasClass)(e.target,g)?e.target:(0,h.gpeByClass)(g,e.target);this._setHoverItem(t)}})),(0,d.addEvent)(this.listInput,"keyup keydown keypress",this._handleInputKeyEvent),(0,d.addEvent)(this.listInput,"click",(()=>{this.show()}))}_handleItemSelected(e){var t=(0,h.hasClass)(e,g)?e:(0,h.gpeByClass)(g,e),s=(0,h.domData)(t,"name"),i=(0,h.domData)(t,"id");i&&this.options.onUserSelected(i,s),(0,h.hasClass)(e,c)&&this.freeTerm&&this.options.onUserSelected(0,this.freeTerm)}_getItemEleById(e){return(0,h.domQuery1)(`[data-id="${e}"]`,this.listDropdown)}_setListHTML(e){(this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent).innerHTML=e}_setHoverItem(e,t){void 0===t&&(t=!1);var s=(0,h.domData)(e,"id");if(s&&s!==this.hoverItem){if(this.hoverItem){var i=this._getItemEleById(this.hoverItem);(0,h.removeClass)(i,"hover")}this.hoverItem=s,(0,h.addClass)(e,"hover"),t&&this.scroll&&this.scroll&&this.scroll.scrollIntoView(e)}}show(e){(0,h.hasClass)(this.friendsdListNode,"show-dropdown")||(this._renderFriendsList(this.lastSeachTerm,e),(0,h.addClass)(this.friendsdListNode,"show-dropdown"),this._resetScroll(),this.scroll&&this.scroll.update())}_renderFriendsList(e,t){if(void 0===t&&(t=!1),e=(0,n.trim)(e),(0,i.getIndexedFriends)()){var s=this._doSearch(e);this._renderFriendsDropdown(e,s,t)}else this._setListHTML(`<div class="${u}">${(0,a.getLang)("box_loading")}</div>`);clearTimeout(this.requestTimeout),e.length>0&&e!==this.lastSeachTerm&&(this.requestTimeout=setTimeout((()=>{this.fetchFriendsWithQuery(e)}),300))}_initScroll(){o.browser.safari||window.stManager.add(["ui_common.css","ui_common.js"],(()=>{this.scroll=new window.uiScroll(this.listContent,{global:!0})}))}_handleInputKeyEvent(e){if("keyup"===e.type){switch(e.keyCode){case d.KEY.ENTER:this._handleEnter();break;case d.KEY.ESC:return this.options.onEscapePress(),void this._hideDropdown();default:var t=e&&e.target.value;t!==this.lastSeachTerm&&(this._renderFriendsList(t),this.lastSeachTerm=t,this.hoverItem=null)}this.options.onKeyUp(),this.show()}else switch(e.keyCode){case d.KEY.UP:case d.KEY.DOWN:this._handleArrows(e.keyCode===d.KEY.DOWN)}}_handleArrows(e){var t,s;if(void 0===e&&(e=!0),this.keyboardNavigation||(this.keyboardNavigation=!0,(0,d.addEvent)(this.listDropdown,"mousemove",this._handleMouseMoveOnce)),this.hoverItem)t=this._getItemEleById(this.hoverItem),s=e?(0,h.domNS)(t):(0,h.domPS)(t);else{var i=this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent;s=(0,h.domFC)(i)}s&&this._setHoverItem(s,!0)}_handleMouseMoveOnce(){this.keyboardNavigation=!1,(0,d.removeEvent)(this.listDropdown,"mousemove",this._handleMouseMoveOnce)}_handleEnter(){if(this.hoverItem){var e=this._getItemEleById(this.hoverItem);this._handleItemSelected(e)}}_doSearch(e){var t;void 0===e&&(e="");var s,o,a,r=(0,i.getPhotoData)("tagged"),n=(0,i.getIndexedFriends)();e.length>0?(s=this.topUsers.search(e),o=n.search(e),a=cur.pvServerFriendsIndex.search(e)):(s=this.topUsers.list,o=n.list,a=cur.pvServerFriendsIndex.list),t=s.concat(o,a);var d=[];return(t=t.filter((e=>{var t=e[0],s=d.indexOf(t)<0&&(!r||!r[t]);return d.push(t),s}))).length>20&&(t=t.slice(0,20)),t}_renderFriendsDropdown(e,t,s){void 0===s&&(s=!1);var i="";if(t.forEach((e=>{var t=e[0],s=e[1],o=e[2],a=e[3],r=`id${t}`;i+=this._getItemHtml(t,s,o,a,r)})),!i&&s){this.freeTerm=e,e=(0,r.clean)(e);var o=(0,a.getLang)("photos_tags_not_found_tag_text").replace("{tagName}",`<span class="add_term_tag">${e}</span>`);i=`<div class="${u}">${o}</div>`,this._setListHTML(i)}else i&&(this._setListHTML(i),this.freeTerm=null,this._resetScroll());this.hoverItem=null}focus(){this.listInput.focus()}reset(){this.listInput.value="",this.lastSeachTerm="",this.hoverItem=null,this._resetScroll()}_resetScroll(){this.scroll?this.scroll.scrollTop():this.listContent.scrollTop=0}fetchFriendsList(){ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags"},{onDone:e=>{(0,i.setIndexedFriends)(e,(()=>{this._renderFriendsList(this.lastSeachTerm)}))}})}fetchFriendsWithQuery(e){ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags",str:e,photo:(0,i.getPhotoData)("id")},{onDone:t=>{this._handleFetchFriends(e,t)}})}_handleFetchFriends(e,t){if(void 0===t&&(t=[]),this.lastSeachTerm===e){var s,o=0,a=(0,i.getPhotoData)("tagged");(s=a?t.filter((e=>{var t=e[0];return!a[t]})):t).forEach((e=>{var t=e[0];cur.pvServerFriendsIds.indexOf(t)<0&&(cur.pvServerFriendsIds.push(t),cur.pvServerFriendsIndex.add(e),o++)})),(o>0||0===s.length)&&this._renderFriendsList(e,!0)}}}},773665:(e,t,s)=>{s.d(t,{default:()=>v});s(821249),s(115306),s(323123),s(454747);var i=s(873589),o=s(342269),a=s(152278),r=s(146143),n=s(70162),d=s(416838),h=s(996885),l=s(123251),g=s(506770),u=s(365931),c="area_hover",p="visible_all";const v=class{constructor(e,t){this.imageNode=e,this.containerNode=t,this.activeAreaId=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this._handleImageMouseMove=this._handleImageMouseMove.bind(this),this._handleAreaClick=this._handleAreaClick.bind(this),this._removeActiveAreaAfterTimeout=this._removeActiveAreaAfterTimeout.bind(this),this._queueCheckUpdates=this._queueCheckUpdates.bind(this),this._queueReceiveUpdates=this._queueReceiveUpdates.bind(this),this._userSelectedCallback=this._userSelectedCallback.bind(this),this._handleSuggestionDeclined=this._handleSuggestionDeclined.bind(this),this.updatePhotoViewTags=this.updatePhotoViewTags.bind(this),this.deleteTag=this.deleteTag.bind(this),this._init(),this._queueCheckUpdates()}_init(){var e=(0,g.partConfigEnabled)("photo_recognition_web");this.photoTooltip=new d.default(window.layer,{onMouseLeave:this._removeActiveAreaAfterTimeout,onUserSelected:this._userSelectedCallback,onDeleteClicked:this.deleteTag,onEscapePressed:this._removeActiveAreaAfterTimeout,onSuggestionDeclined:this._handleSuggestionDeclined,hideAfterDecline:e}),this.photoView=window.Photoview,this.areasContainer=(0,i.ce)("div",{className:"photo_tags_suggested_areas_list"}),this.containerNode.innerHTML="",this.containerNode.appendChild(this.areasContainer),(0,a.addEvent)(this.imageNode,"mousemove",this._handleImageMouseMove),(0,a.addEvent)(this.imageNode,"mouseleave",this._removeActiveAreaAfterTimeout),(0,a.addEvent)(this.imageNode,"mouseenter",this.showAllSuggestedAreas.bind(this)),(0,a.addEvent)(this.areasContainer,"mouseleave",this._removeActiveAreaAfterTimeout),(0,a.addEvent)(this.areasContainer,"click",this._handleAreaClick),this.renderTagAreas()}_handleImageMouseMove(e){if(!this.areasHidden){var t=(0,i.getXY)(e.target),s=Math.round(100*(e.pageX-t[0])/e.target.offsetWidth),o=Math.round(100*(e.pageY-t[1])/e.target.offsetHeight);for(var a in clearTimeout(this.areasTimeOut),this.areasTimeOut=setTimeout((()=>{this.photoTooltip.isActive||this.activeAreaId||this.hideAllSuggestedAreas()}),700),this.showAllSuggestedAreas(),this.areas)if(this.areas.hasOwnProperty(a)){var r=this.areas[a],n=r.x,d=r.y,h=r.x2,l=r.y2;if(s>parseInt(n)&&s<parseInt(h)&&o>parseInt(d)&&o<parseInt(l)){if(a===this.activeAreaId)return void(this.tagAreaFound=!0);if(this.tagAreaFound=this.showTagArea(a),this.tagAreaFound)return}}this.tagAreaFound=!1,this._removeActiveAreaAfterTimeout()}}_handleAreaClick(e){(0,a.cancelEvent)(e),this.photoTooltip.showAndFocusFriendsList(e)}showTagArea(e){var t=this.areas[e];return!(!t||t.isDeleted)&&(null!==this.activeAreaId&&this.areas[this.activeAreaId]&&(0,i.removeClass)(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=e,(0,i.addClass)(this.areas[e].ele,"active"),this.showTooltip(e),this.showAllSuggestedAreas(),!0)}hideTagArea(){clearTimeout(this.waitTimeout),null!==this.activeAreaId&&this.areas[this.activeAreaId]&&(0,i.removeClass)(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=null,this.photoTooltip.hide(),this.hideAllSuggestedAreas()}_removeActiveAreaAfterTimeout(e){void 0===e&&(e=500),this.activeAreaId&&!this.waitToRemove&&(this.waitToRemove=!0,clearTimeout(this.waitTimeout),this.waitTimeout=setTimeout((()=>{!this.photoTooltip.isActive&&!this.tagAreaFound&&!this.photoTooltip.interaction&&this.hideTagArea(),this.waitToRemove=!1}),e))}showTooltip(e){if(!this.tooltipsPaused){var t=this.areas[e].ele,s=this._getTooltipOptions(e);if(t){var o=(0,i.getXYRect)(t,!0),a=o.top,r=o.right,n=o.bottom,d=o.left;this.photoTooltip.show({top:a,right:r,bottom:n,left:d},s)}}}showAllSuggestedAreas(){(0,i.addClass)(this.areasContainer,p),(0,i.removeClass)(this.areasContainer,c),this.activeAreaId&&(0,i.addClass)(this.areasContainer,c)}hideAllSuggestedAreas(){(0,i.removeClass)(this.areasContainer,p)}pauseTooltips(){this.hideTagArea(),this.tooltipsPaused=!0}resumeTooltips(){this.tooltipsPaused=!1}_createTagElement(e,t,s,o){var a=cur.pvPhWidth,r=cur.pvPhHeight/a,n=s-e,d=o-t,h=(0,i.ce)("div",{className:"photo_tags_suggested_area"},{left:`${e}%`,marginTop:r*t+"%",width:`${n}%`}),l=(0,i.ce)("div",{},{paddingBottom:100*r*(d/n)+"%"});return h.appendChild(l),h}renderTagAreas(){this.areas={},this.areasContainer.innerHTML="";var e=(0,h.getPhotoData)("tags"),t=(0,h.getPhotoData)("suggested_tags"),s=(0,g.partConfigEnabled)("photo_recognition_web");for(var i in!s&&cur.postTo&&cur.postTo<0&&(t=[]),e)if("0"!==i&&e.hasOwnProperty(i)){var o=e[i],a=o[0],r=o[1],n=o[2],d=o[3],l=o[4],u=o[5],c=o[6],p=this._createTagElement(a,r,n,d);this.areas[i]={ele:p,x:a,y:r,x2:n,y2:d,userName:l,userHref:u,canDeleteTag:Boolean(c),confirmedTag:!1},this.areasContainer.appendChild(p)}for(var v in t)if(v&&t.hasOwnProperty(v)){var _=t[v],m=_[0],f=_[1],w=_[2],T=_[3],S=_[4],A=_[5],C=_[6],I=this._createTagElement(m,f,w,T),N=void 0;S&&(N=`/id${S}`),this.areas[v]={ele:I,x:m,y:f,x2:w,y2:T,userHref:N,suggestedUserId:S,suggestedUserName:A,usersList:C,confirmedTag:!1},this.areasContainer.appendChild(I)}}_userSelectedCallback(e,t,s){void 0===s&&(s=!1);var i=(0,h.getPhotoData)("tags"),a=(0,h.getPhotoData)("suggested_tags"),r=(0,g.partConfigEnabled)("photo_recognition_web"),n=this.activeAreaId,d=this.areas[n],l=d.x,u=d.y,c=d.x2,p=d.y2,v=`/id${e}`,_=cur.pvAskForAutoTag&&s,m=(0,o.clean)(t),f={suggestedUserId:!1,suggestedUserName:!1,usersList:[],userId:e,userName:m,userHref:v,canDeleteTag:!0},w=this.activeAreaId;r?this.confirmSuggestedTags([n],(()=>{this.activeAreaId=w,this.photoTooltip.updateState(f),this.showTagArea(w),this._removeActiveAreaAfterTimeout(1e3)})):(i[n]=[l,u,c,p,m,v,!0],delete a[n],this._confirmSuggestedTag(n,e,t,r,(()=>{this.activeAreaId=w,this.areas[w]=(0,o.extend)(d,f),this.photoTooltip.updateState(f),this.showTagArea(w),this._removeActiveAreaAfterTimeout(1e3),_&&(cur.pvAskForAutoTag=!1,this.showSettingsBox())})))}showSettingsBox(){(0,r.showBox)("/al_photos.php",{act:"show_autotag_settings"},{params:{grey:!0,width:450,bodyStyle:{padding:0},hideButtons:!0,titleTransparent:!0},onDone:(e,t)=>{var s=e.bodyNode,i=s=>{e.hide(),window.ajax.post("/al_settings.php",{act:"a_change_autotag_friends",hash:t.hash,autotag_friends:s?1:0})};s.querySelector(".AutotagSettingsBox__yesButton").addEventListener("click",(()=>i(!0))),s.querySelector(".AutotagSettingsBox__noButton").addEventListener("click",(()=>i(!1)))}})}confirmAlert(e){void 0===e&&(e=!1);var t=cur.pvOneSuggestHintId,s=cur.pvOneSuggestHintHash;e?(t=cur.pvSomeSuggestsHintId,s=cur.pvSomeSuggestsHintHash,cur.pvNeedShowAlertForSomeSuggests=!1):cur.pvNeedShowAlertForOneSuggest=!1,window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:t,hash:s},{onDone:()=>{},onFail:()=>(console.error("something wrong with help hint"),!0)})}deleteTag(e){e||(e=this.activeAreaId,this.photoView.deleteTag(e)),this.hideTagArea();var t=this.areas[e];e&&t&&(t=(0,o.extend)(t,{isDeleted:!0}),(0,i.addClass)(t.ele,"deleted"))}_getTooltipOptions(e){var t=this.areas[e],s=t.suggestedUserId,i=t.suggestedUserName;return{suggestedUserId:s,userName:t.userName,userHref:t.userHref,suggestedUserName:i,usersList:t.usersList,canDeleteTag:t.canDeleteTag}}_handleSuggestionDeclined(){var e=this.activeAreaId,t=this.areas[e];if(t){var s=(0,h.getPhotoData)("suggested_tags"),i=(0,g.partConfigEnabled)("photo_recognition_web");this.areas[e]=(0,o.extend)(t,{suggestedUserId:!1,suggestedUserName:!1,userHref:null}),s&&s[e]&&(s[e][4]=0),i?this.declineSuggestedTags([e]):(this.showTagArea(e),this._declineSuggestedTag(e))}}declineSuggestedTags(e,t,s){var o=(0,h.getPhotoData)("id"),a=(0,h.getPhotoData)("hash"),r=cur.pvListId,d=cur.pvIndex,g=cur.pvData[r][d],u=(0,h.getPhotoData)("tags"),c=e.map((e=>`${o}_${e}`)).join(",");ajax.post("al_photos.php",{act:"decline_suggested_tags",tag_raw_ids:c,hash:a,extended:1},{onDone:(s,a,h)=>{this.decrementLeftMenuCounterIfNeeded(e),this.updatePhotoViewSuggestedTags(s,a,g),this.dispatchEvent(l.TagEventTypes.DECLINE_SUGGESTED_TAGS,{tagIds:e.map(Number),photoRawId:o}),r===cur.pvListId&&d===cur.pvIndex&&(!g.taginfo&&g.actions.tag&&u[0]<cur.pvMaxTags?(0,i.show)(cur.pvTagLink):(0,i.hide)(cur.pvTagLink),s||a||this.photoView.toggleTopInfoPanel((0,n.getLang)("photos_tag_deleted"),h)),t&&t()},onFail:e=>(e||(e=(0,n.getLang)("global_unknown_error")),s&&s(),this.handleTagRequestFail(e))})}confirmSuggestedTags(e,t,s){var o=cur.pvListId,a=cur.pvIndex,d=cur.pvData[o][a],g=(0,h.getPhotoData)("id"),u=(0,h.getPhotoData)("hash"),c=(0,h.getPhotoData)("suggested_tags"),p=e.length>1,v=e[0],_=c[v][4],m=()=>{var r=e.map((e=>`${g}_${e}`)).join(",");ajax.post("al_photos.php",{act:"confirm_suggested_tags",tag_raw_ids:r,hash:u,extended:1},{onDone:(s,r,n,h,u)=>{this.decrementLeftMenuCounterIfNeeded(e),this.updatePhotoViewTags(s,r,n,d),this.updatePhotoViewSuggestedTags(h,u,d),this.dispatchEvent(l.TagEventTypes.CONFIRM_SUGGESTED_TAGS,{tagIds:e.map(Number),photoRawId:g}),o===cur.pvListId&&a===cur.pvIndex&&(!d.taginfo&&d.actions.tag&&s[0]<cur.pvMaxTags?(0,i.show)(cur.pvTagLink):(0,i.hide)(cur.pvTagLink)),t&&t()},onFail:e=>(e||(e=(0,n.getLang)("global_unknown_error")),s&&s(),this.handleTagRequestFail(e))})};if(cur.pvNeedShowAlertForOneSuggest&&!p&&_!==window.vk.id||cur.pvNeedShowAlertForSomeSuggests&&p){var f="",w="",T="";if(p){var S=e.reduce(((e,t)=>{var s=c[t],i=s&&s[4];return i&&i!==window.vk.id&&(e[i]=!0),e}),{}),A=Object.keys(S).length;w=(0,n.getLang)("photo_recognition_some_tag_alert",A),f=(0,n.getLang)("photo_recognition_some_friends_alert_text",A),T=(0,n.getLang)("photo_recognition_some_friends_submit_btn")}else{var C=c[v][5],I=c[v][7];w=(0,n.getLang)("photo_recognition_one_tag_alert"),f=(0,n.langSex)(I,(0,n.getLang)("photo_recognition_one_tag_alert_text","raw")).replace("{name}",C),T=(0,n.getLang)("photo_recognition_one_friend_submit_btn")}var N=(0,r.showFastBox)(w,f,T,(()=>{N.hide(),m(),this.confirmAlert(p)}),(0,n.getLang)("global_cancel"),(()=>{N.hide(),s&&s()}))}else m()}decrementLeftMenuCounterIfNeeded(e){var t=(0,h.getPhotoData)("suggested_tags");e.forEach((e=>{var s=t[e],i=s&&s[4];i&&i===window.vk.id&&(0,u.decrementLeftMenuPhotoCounter)()}))}_confirmSuggestedTag(e,t,s,i,o){var a=(0,h.getPhotoData)("id"),r=(0,h.getPhotoData)("hash");ajax.post("al_photos.php",{act:"confirm_suggested_tag",tag:e,tagged_id:t,name:s,photo:a,hash:r},{onDone:(e,t,s)=>{this.updatePhotoViewTags(e,t,s),o()},onFail:this.handleTagRequestFail})}_declineSuggestedTag(e){var t=(0,h.getPhotoData)("id"),s=(0,h.getPhotoData)("hash");ajax.post("al_photos.php",{act:"decline_suggested_tag",tag:e,photo:t,hash:s},{onFail:this.handleTagRequestFail})}dispatchEvent(e,t){this.areasContainer.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0}))}handleTagRequestFail(e){var t=(0,n.getLang)("global_error");return setTimeout((0,r.showFastBox)(t,e).hide,3e3),!0}unMount(){(0,a.removeEvent)(this.imageNode,"mousemove",this._handleImageMouseMove),(0,a.removeEvent)(this.areasContainer,"click",this._handleAreaClick),this.containerNode.innerHTML=""}hideAreas(){this.areasHidden=!0,(0,i.hide)(this.areasContainer),this.photoTooltip.hide()}showAreas(){this.areasHidden=!1,(0,i.show)(this.areasContainer),(0,a.removeEvent)(this.imageNode,"mousemove",this._handleImageMouseMove),(0,a.addEvent)(this.imageNode,"mousemove",this._handleImageMouseMove)}reload(e){void 0===e&&(e=null),this.hideTagArea(),this.resumeTooltips(),this.renderTagAreas(),e&&(this.imageNode=e),this.activeAreaId=null,this.waitToRemove=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this.showAreas()}_queueCheckUpdates(){cur.pvTagsQueueParams&&window.Notifier&&Notifier.addKey(cur.pvTagsQueueParams,this._queueReceiveUpdates)}updatePhotoViewTags(e,t,s,i){void 0===i&&(i=null),(i=i||(0,h.getCurrentPhoto)())&&(i.tags=e,i.tagged=t,i.tagshtml=s,this.photoView.setTags(s))}updatePhotoViewSuggestedTags(e,t,s){void 0===s&&(s=null),(s=s||(0,h.getCurrentPhoto)())&&(e&&Object.keys(e).length?s.suggested_tags=e:delete s.suggested_tags,t?(s.suggestedTagsInfo=t,this.photoView.showSuggestedInfoTopPanel(cur.pvCurPhoto)):(delete s.suggestedTagsInfo,this.photoView.toggleTopInfoPanel(!1)),this.reload())}_queueReceiveUpdates(e,t){t.events&&t.events.forEach((e=>{var t=e.split("<!>"),s=t[1],i=t[2],o=JSON.parse(i),a=JSON.parse(t[3]),r=JSON.parse(t[4]),n=t[5];if((0,h.getPhotoData)("id")===s)(0,h.setPhotoData)("suggested_tags",o),this.updatePhotoViewTags(a,r,n),this.renderTagAreas();else if(cur.pvData){var d=function(e){if(cur.pvData.hasOwnProperty(e)){var t=cur.pvData[e];t.length&&t.forEach(((t,i)=>{if(t.id&&t.id===s){var d=cur.pvData[e][i];d.suggested_tags=o,d.tags=a,d.tagged=r,d.tagshtml=n}}))}};for(var l in cur.pvData)d(l)}}))}}},416838:(e,t,s)=>{s.d(t,{default:()=>h});s(115306);var i=s(984561),o=s(152278),a=s(873589),r=s(342269),n=s(608021),d="right_top";const h=class{constructor(e,t){void 0===t&&(t={}),this.options=(0,r.extend)({closeOnClick:!0,resetDropdownOnShow:!0,onUserSelected:()=>!1,onMouseLeave:()=>!1,onEscapePressed:()=>!1,onDeleteClicked:()=>!1,onSuggestionDeclined:()=>!1},t),this.container=e,this.friendsDropdown=new i.default({onUserSelected:this._handleUserSelected.bind(this),onEscapePress:this._handleEscapePress.bind(this),onKeyUp:this._handleStartInteraction.bind(this)}),this.friendsDropdownNode=this.friendsDropdown.init(),this._handleConfirmedTooltipClick=this._handleConfirmedTooltipClick.bind(this),this._handleDocumentClick=this._handleDocumentClick.bind(this),this.renderTooltip()}renderTooltip(){this.tooltipNode=(0,a.ce)("div",{className:"photo_tooltip"},{display:"none"});var e=(0,a.ce)("div",{className:"photo_tooltip__content"});this.sugggestionNode=(0,a.ce)("div"),this.nameNode=(0,a.ce)("div",{className:"photo_tooltip__name"},{display:"none"}),this.listNode=(0,a.ce)("div",{className:"photo_tooltip__suggestion"}),this.listNode.appendChild(this.friendsDropdownNode),(0,o.addEvent)(this.nameNode,"click",this._handleConfirmedTooltipClick),e.appendChild(this.nameNode),e.appendChild(this.sugggestionNode),e.appendChild(this.listNode),this.tooltipNode.appendChild(e),this.container.appendChild(this.tooltipNode),(0,o.addEvent)(this.tooltipNode,"mouseenter",(()=>{this.isActive=!0})),(0,o.addEvent)(this.sugggestionNode,"click",(e=>{switch((0,o.cancelEvent)(e),(0,a.domData)(e.target,"button")){case"yes":this.options.onUserSelected(this.suggestedUserId,this.suggestedUserName,!0);break;case"no":this.options.onSuggestionDeclined(),(0,a.hide)(this.sugggestionNode),this.userHref=null,this.options.hideAfterDecline?this.hide():(this.showFriendsList(),this.showAndFocusFriendsList())}})),(0,o.addEvent)(this.tooltipNode,"mouseleave",(()=>{this.interaction||(this.isActive=!1,this.options.onMouseLeave())})),this.options.closeOnClick&&(0,o.addEvent)(document,"click",this._handleDocumentClick)}_handleDocumentClick(e){this.options.onMouseLeave(),this.interaction=!1,this.isActive=!1,this.hide()}_handleUserSelected(e,t){this.isActive=!1,this.options.onUserSelected(e,t)}_handleEscapePress(){this.isActive=!1,this.interaction=!1,this.friendsDropdown.reset(),this.options.onEscapePressed()}_handleStartInteraction(){this.interaction=!0}_handleConfirmedTooltipClick(e){(0,o.cancelEvent)(e),"button"===e.target.tagName.toLowerCase()?this.options.onDeleteClicked():this.userHref&&this._go(this.userHref,e)}updatePosition(e){var t=e.top,s=e.right,i=e.bottom,o=e.left,r=s-o,n=(0,a.getSize)(this.tooltipNode),h=n[0]?n[0]:280,l="bottom",g=o+Math.floor(r/2)-h/2,u=i;if((g<10||this.hasDropdown&&i>(0,a.clientHeight)()-300)&&(l=d),l===d){g=s,u=t;var c=(0,a.clientHeight)()-t;c<300&&(u=t-300+c)}(0,a.domData)(this.tooltipNode,"dir",l),(0,a.setStyle)(this.tooltipNode,{top:u,left:g})}updateSuggestionQuestion(e,t){this.sugggestionNode.innerHTML=this._getSuggestionHTML(e,t),this.suggestedUserName=t,this.suggestedUserId=e}_getSuggestionHTML(e,t){var s=e===vk.id?(0,n.getLang)("photos_tags_user_you"):t;return`<div class="suggested_tag_user">\n      ${(0,n.langTag)("<div>","</div>",(0,n.getLang)("photos_tags_suggestion_question"),"tag_span").replace("{userName}",`<div class="suggested_tag_user__name">&nbsp;${s}</div>`)}\n      <div class="suggested_tag_user__actions">\n        <button data-button="yes" class="yes">${(0,n.getLang)("box_yes")}</button>\n        <span>&middot;</span>\n        <button data-button="no">${(0,n.getLang)("box_no")}</button>\n      </div>\n    </div>`}updateState(e){var t=e.suggestedUserName,s=e.suggestedUserId,i=e.usersList,o=e.userName,r=e.userHref,n=e.canDeleteTag;this.suggestedUserName=!1,this.suggestedUserId=!1,this.userHref=r,this.hasDropdown=!1,(0,a.removeClass)(this.tooltipNode,"tagged"),o?(this.nameNode.innerHTML=`${o} ${n?"<button>Delete</button>":""}`,(0,a.toggleClass)(this.nameNode,"show_delete",n),(0,a.show)(this.nameNode),(0,a.hide)(this.listNode),(0,a.hide)(this.sugggestionNode),(0,a.addClass)(this.tooltipNode,"tagged")):s?(this.updateSuggestionQuestion(s,t),(0,a.hide)(this.nameNode),(0,a.hide)(this.listNode),(0,a.show)(this.sugggestionNode)):(this.friendsDropdown.update(i),(0,a.hide)(this.nameNode),(0,a.hide)(this.sugggestionNode),this.showFriendsList(),this.hasDropdown=!0)}showFriendsList(){(0,a.show)(this.listNode),this.options.resetDropdownOnShow&&this.resetFriendsDropdown()}resetFriendsDropdown(){this.friendsDropdown.reset()}show(e,t,s){void 0===t&&(t={}),void 0===s&&(s=!1),this.isActive=!1,this.interaction=!1,this.updateState(t),this.updatePosition(e),(0,a.show)(this.tooltipNode),s&&this.friendsDropdown.show(!0),this.friendsDropdown.focus()}hide(){(0,a.hide)(this.tooltipNode)}showAndFocusFriendsList(e){this.userHref?this._go(this.userHref,e):(this.friendsDropdown.focus(),this.friendsDropdown.show())}unMount(){(0,o.removeEvent)(document,"click",this._handleDocumentClick),(0,a.re)(this.tooltipNode)}_go(e,t){t&&t.ctrlKey?window.open(e):nav.go(e,t)}}},332925:(e,t,s)=>{var i=s(773665),o=s(416838);window.PhotoTags=i.default,window.PhotoTooltip=o.default;try{window.stManager.done(window.jsc("web/photos_module.js"))}catch(e){}},365931:(e,t,s)=>{s.d(t,{decrementLeftMenuPhotoCounter:()=>n});var i=s(342269),o=s(66433),a=s(101178),r="ph";function n(e){void 0===e&&(e=1);try{var t=function(){var e=document.getElementById("l_ph");if(!e)throw new Error("There is not photo left menu item");var t=e.querySelector(".left_count");return t?(0,i.intval)(t.textContent):0}();(0,a.handlePageCount)(r,Math.max(t-e,0))}catch(e){console.error(e),(0,o.logError)(e)}}},123251:(e,t,s)=>{var i;s.d(t,{TagEventTypes:()=>i}),function(e){e.CONFIRM_SUGGESTED_TAGS="CONFIRM_SUGGESTED_TAGS",e.DECLINE_SUGGESTED_TAGS="DECLINE_SUGGESTED_TAGS",e.DECLINE_USER_TAG="DECLINE_USER_TAG",e.CONFIRM_USER_TAG="CONFIRM_USER_TAG",e.DELETE_TAG="DELETE_TAG"}(i||(i={}))}},n={};function d(e){var t=n[e];if(void 0!==t)return t.exports;var s=n[e]={exports:{}};return r[e].call(s.exports,s,s.exports,d),s.exports}d.m=r,e=[],d.O=(t,s,i,o)=>{if(!s){var a=1/0;for(l=0;l<e.length;l++){for(var[s,i,o]=e[l],r=!0,n=0;n<s.length;n++)(!1&o||a>=o)&&Object.keys(d.O).every((e=>d.O[e](s[n])))?s.splice(n--,1):(r=!1,o<a&&(a=o));if(r){e.splice(l--,1);var h=i();void 0!==h&&(t=h)}}return t}o=o||0;for(var l=e.length;l>0&&e[l-1][2]>o;l--)e[l]=e[l-1];e[l]=[s,i,o]},d.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return d.d(t,{a:t}),t},s=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,d.t=function(e,i){if(1&i&&(e=this(e)),8&i)return e;if("object"==typeof e&&e){if(4&i&&e.__esModule)return e;if(16&i&&"function"==typeof e.then)return e}var o=Object.create(null);d.r(o);var a={};t=t||[null,s({}),s([]),s(s)];for(var r=2&i&&e;"object"==typeof r&&!~t.indexOf(r);r=s(r))Object.getOwnPropertyNames(r).forEach((t=>a[t]=()=>e[t]));return a.default=()=>e,d.d(o,a),o},d.d=(e,t)=>{for(var s in t)d.o(t,s)&&!d.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},d.f={},d.e=e=>Promise.all(Object.keys(d.f).reduce(((t,s)=>(d.f[s](e,t),t)),[])),d.u=e=>9375===e?"voice_message_player.1ca99e7ec51aef6df7b5.js":28762===e?"speech.ec5bb88b79217da0bc5d.js":57468===e?"SilentModeForms.710e5d0929fe4e8d2b72.js":75980===e?"menu_settings.0f17151bd588fe6a5267.js":void 0,d.miniCssF=e=>e+"."+{57468:"28053bce032a9da83885",75980:"95eccc249ab38cb1e901"}[e]+".css",d.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),d.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i={},d.l=(e,t,s,o)=>{if(i[e])i[e].push(t);else{var a,r;if(void 0!==s)for(var n=document.getElementsByTagName("script"),h=0;h<n.length;h++){var l=n[h];if(l.getAttribute("src")==e||l.getAttribute("data-webpack")=="vk:"+s){a=l;break}}a||(r=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,d.nc&&a.setAttribute("nonce",d.nc),a.setAttribute("data-webpack","vk:"+s),a.src=e),i[e]=[t];var g=(t,s)=>{a.onerror=a.onload=null,clearTimeout(u);var o=i[e];if(delete i[e],a.parentNode&&a.parentNode.removeChild(a),o&&o.forEach((e=>e(s))),t)return t(s)},u=setTimeout(g.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=g.bind(null,a.onerror),a.onload=g.bind(null,a.onload),r&&document.head.appendChild(a)}},d.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},d.p="/dist/",o=e=>new Promise(((t,s)=>{var i=d.miniCssF(e),o=d.p+i;if(((e,t)=>{for(var s=document.getElementsByTagName("link"),i=0;i<s.length;i++){var o=(r=s[i]).getAttribute("data-href")||r.getAttribute("href");if("stylesheet"===r.rel&&(o===e||o===t))return r}var a=document.getElementsByTagName("style");for(i=0;i<a.length;i++){var r;if((o=(r=a[i]).getAttribute("data-href"))===e||o===t)return r}})(i,o))return t();((e,t,s,i)=>{var o=document.createElement("link");o.rel="stylesheet",o.type="text/css",o.onerror=o.onload=a=>{if(o.onerror=o.onload=null,"load"===a.type)s();else{var r=a&&("load"===a.type?"missing":a.type),n=a&&a.target&&a.target.href||t,d=new Error("Loading CSS chunk "+e+" failed.\n("+n+")");d.code="CSS_CHUNK_LOAD_FAILED",d.type=r,d.request=n,o.parentNode.removeChild(o),i(d)}},o.href=t,document.head.appendChild(o)})(e,o,t,s)})),a={22866:0},d.f.miniCss=(e,t)=>{a[e]?t.push(a[e]):0!==a[e]&&{57468:1,75980:1}[e]&&t.push(a[e]=o(e).then((()=>{a[e]=0}),(t=>{throw delete a[e],t})))},(()=>{var e={22866:0};d.f.j=(t,s)=>{var i=d.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else if(75980!=t){var o=new Promise(((s,o)=>i=e[t]=[s,o]));s.push(i[2]=o);var a=d.p+d.u(t),r=new Error;d.l(a,(s=>{if(d.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var o=s&&("load"===s.type?"missing":s.type),a=s&&s.target&&s.target.src;r.message="Loading chunk "+t+" failed.\n("+o+": "+a+")",r.name="ChunkLoadError",r.type=o,r.request=a,i[1](r)}}),"chunk-"+t,t)}else e[t]=0},d.O.j=t=>0===e[t];var t=(t,s)=>{var i,o,[a,r,n]=s,h=0;for(i in r)d.o(r,i)&&(d.m[i]=r[i]);if(n)var l=n(d);for(t&&t(s);h<a.length;h++)o=a[h],d.o(e,o)&&e[o]&&e[o][0](),e[a[h]]=0;return d.O(l)},s=self.webpackChunkvk=self.webpackChunkvk||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var h=d.O(void 0,[76429,75514,24509,56990,98066,76400,40885,68592],(()=>d(332925)));h=d.O(h)})();